AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  AccountName:
    Description: '(Optional)- Takes account name as input'
    Type: 'String'
  ReportingPlatform:
    Description: 'Takes comma seperated reporting values, allowed values are S3, Slack, Email'
    Type: 'String'
    Default: 's3'
  SlackChannelName:
    Description: '(If you have chosen slack as a reporting platform)Takes slack channel name as input. Keep the defaults in case slack notifications are not required'
    Type: 'String'
    Default: '-'
  WebhookUrl:
    Description: '(If you have chosen slack as a reporting platform)Takes slack webhook url as input . Keep the defaults in case slack notifications are not required'
    Type: 'String'
    Default: '-'
  SenderEmailAddress:
    Type: 'String'
    Description: '(If you have chosen email as a reporting platform) Takes the email id from which the mail containing cost report will be sent. Keep the defaults in case email notifications are not required'
  RecipientEmailAddress:
    Description: '(If you have chosen email as a reporting platform) Takes email id to which the mail containing cost report will be sent. Keep the defaults in case email notifications are not required'
    Type: 'String'
  SESRegion:
    Description: '(Optional) Takes the AWS region abbreviation (e.g. ap-south-1 for Mumbai) in which SES is configured'
    Type: 'String'
    Default: 'us-east-1'
  ReportBucket:
    Description: '(Optional)- Takes existing S3 bucket to store reports'
    Type: "String"

Conditions:
  CreateReportBucket: !Equals
    - !Ref ReportBucket
    - ""
  VerifyToEmail: !Equals
    - !Ref RecipientEmailAddress
    - ""
  IfToEmailNotNull: !Not
    - Condition: VerifyToEmail
  VerifyFromEmail: !Equals
    - !Ref SenderEmailAddress
    - ""
  IfFromEmailNotNull: !Not
    - Condition: VerifyFromEmail

Resources:
  ManagedReportBucket:
    Type: AWS::S3::Bucket
    Condition: CreateReportBucket
    Properties:
      BucketName:  !Join
      - "-"
      - - "pennypincher-managedbucket"
        - !Select
          - 0
          - !Split
            - "-"
            - !Select
              - 2
              - !Split
                - "/"
                - !Ref "AWS::StackId"
      
  ServiceRoleForLambda:
    Type: 'AWS::IAM::Role'
    Description: 'IAM role for Penny Pincher'
    Properties:
      RoleName: !Join
      - "-"
      - - "Penny-Pincher-Docker-Lambda"
        - !Select
          - 0
          - !Split
            - "-"
            - !Select
              - 2
              - !Split
                - "/"
                - !Ref "AWS::StackId"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service:
                - 'lambda.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSESFullAccess
      Policies:
        - PolicyName: 'Penny-Pincher-Lambda-Inline-Policy'
          PolicyDocument: !Sub
            - '{
                   "Version": "2012-10-17",
                   "Statement": [
                       {
                           "Sid": "VisualEditor0",
                           "Effect": "Allow",
                           "Action": [
                               "ec2:DescribeImages",
                               "ec2:DescribeInstances",
                               "ec2:DescribeRegions",
                               "ec2:DescribeVolumes",
                               "ec2:DescribeAddresses",
                               "pricing:GetProducts",
                               "elasticache:DescribeCacheClusters",
                               "es:ListDomainNames",
                               "es:DescribeElasticsearchDomain",
                               "elasticloadbalancing:DescribeLoadBalancers",
                               "rds:DescribeDBInstances",
                               "redshift:DescribeClusters",
                               "ses:SendEmail",
                               "logs:CreateLogStream",
                               "logs:CreateLogGroup",
                               "logs:PutLogEvents",
                               "cloudwatch:GetMetricStatistics",
                               "rds:DescribeOrderableDBInstanceOptions"
                           ],
                           "Resource": "*"
                       },
                       {
                                  "Sid": "VisualEditor1",
                                  "Effect": "Allow",
                                  "Action": "*",
                                  "Resource":"arn:aws:s3:::${ReportBucket}/*"
                      }
                   ]
               }'
            - { ReportBucket: !If [ CreateReportBucket, !Ref ManagedReportBucket, !Ref ReportBucket ] }

  LambdaFunction:
    Type: 'AWS::Lambda::Function'
    Description: 'Generates Cost report with all the idle resources information and sends it to email or slack or both'
    Properties:
      FunctionName: !Join
      - "-"
      - - "Penny-Pincher-Lambda"
        - !Select
          - 0
          - !Split
            - "-"
            - !Select
              - 2
              - !Split
                - "/"
                - !Ref "AWS::StackId"
      Architectures:
        - x86_64
      Runtime: 'python3.8'
      Role: !GetAtt ServiceRoleForLambda.Arn
      Handler: 'main.cfnresponsefun'
      Code:
        S3Bucket: penny-pincher-s3-bucket
        S3Key: 'penny.zip'
      PackageType: 'Zip'
      Timeout: 900
      MemorySize: 1024
      Environment:
        Variables:
          ACCOUNT_NAME: !Ref AccountName
          REPORTING_PLATFORM: !Ref ReportingPlatform
          CHANNEL_NAME: !Ref SlackChannelName
          FROM_ADDRESS: !Ref SenderEmailAddress
          TO_ADDRESS: !Ref RecipientEmailAddress
          SES_REGION: !Ref SESRegion
          REPORT_BUCKET: !If [ CreateReportBucket, !Ref ManagedReportBucket, !Ref ReportBucket ]
          WEBHOOK_URL: !Ref WebhookUrl

  TriggerPennyPincher:
    Type: Custom::TriggerPennyPincher
    DependsOn: LambdaFunction
    Properties:
      ServiceToken: !GetAtt LambdaFunction.Arn

  CronToTriggerLambda:
    Type: AWS::Events::Rule
    Properties:
      Description: "ScheduleRule"
      Name: LambdaTrigger
      ScheduleExpression: cron(0 0 */14 * *)
      State: ENABLED
      Targets:
        - Id: PennypincherLambdafunction
          Arn: !GetAtt LambdaFunction.Arn

  PermissionForEventsToInvokeLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref LambdaFunction
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt CronToTriggerLambda.Arn